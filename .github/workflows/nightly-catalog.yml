name: Nightly Catalog Build

on:
  workflow_dispatch: {}

permissions:
  contents: read
  actions: write

jobs:
  build-catalog:
    if: ${{ github.actor != 'nektos/act' }}
    name: Generate catalog index
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/${{ github.repository_owner }}/ci-base:latest
      options: --user 0:0
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955

      - name: Install dependencies
        run: |
          python-venv-install

      - name: Generate catalog (dist/index.json)
        run: |
          . .venv/bin/activate
          make catalog
          test -f dist/index.json

      - name: Upload index artifact
        if: ${{ github.actor != 'nektos/act' }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: nightly-index-json
          path: dist/index.json
          if-no-files-found: error
          retention-days: 7

      - name: Show index summary
        run: |
          python3 - <<'EOF'
          import json, hashlib
          p = 'dist/index.json'
          with open(p,'rb') as f:
              data = f.read()
          print(f"index.json size={len(data)} bytes sha256={hashlib.sha256(data).hexdigest()[:16]}...")
          obj = json.loads(data)
          print("keys:", sorted(obj.keys()))
          print("packages:", len(obj.get('packages', [])))
          EOF

  noop-act:
    if: ${{ github.actor == 'nektos/act' }}
    runs-on: ubuntu-latest
    steps:
      - run: echo "[act] nightly-catalog skipped."
