name: security-checkov

on:
  workflow_dispatch:
  pull_request:
  # Temporary: run on push to main; when we switch to tag-based flow, some jobs may move to tag triggers
  push:
    branches: [main]

permissions:
  contents: read
  security-events: write # for SARIF upload
  pull-requests: write # to comment on PRs

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  checkov-scan-gh:
    if: ${{ github.actor != 'nektos/act' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Detect Docker availability
        id: docker
        run: |
          set -euo pipefail
          if command -v docker >/dev/null 2>&1 && docker info >/dev/null 2>&1; then
            echo "available=true" >> "$GITHUB_OUTPUT"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run Checkov (Docker) and produce SARIF
        if: ${{ steps.docker.outputs.available == 'true' }}
        env:
          # Pinned image digest is required. Prefer repository variable or secret; local env handled by script under act.
          CHECKOV_IMAGE_DIGEST: ${{ vars.CHECKOV_IMAGE_DIGEST || secrets.CHECKOV_IMAGE_DIGEST }}
        run: |
          set -euo pipefail
          bash tools/ci/checkov-run.sh

      - name: Note when Docker is unavailable
        if: ${{ steps.docker.outputs.available != 'true' }}
        run: |
          echo "::notice::Docker not available; skipping Checkov run."

      - name: Upload SARIF to Code Scanning
        if: ${{ hashFiles('checkov.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@528ca598d956c91826bd742262cdfc5d02b77710
        with:
          sarif_file: checkov.sarif

      - name: Comment summary in PR
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          if [ -s checkov.sarif ] && command -v jq >/dev/null 2>&1; then
            total=$(jq '[(.runs[]?.results // [])[]] | length' checkov.sarif)
          else
            total=0
          fi
          printf "CKV_SUMMARY<<'EOF'\n" >> $GITHUB_ENV
          echo "### Checkov scan" >> $GITHUB_ENV
          echo "- Findings: $total" >> $GITHUB_ENV
          echo "- SARIF uploaded to Code scanning (tool: Checkov)." >> $GITHUB_ENV
          echo "- See Security > Code scanning alerts for full details." >> $GITHUB_ENV
          printf "EOF\n" >> $GITHUB_ENV

      - name: Create or update PR comment
        if: ${{ github.event_name == 'pull_request' }}
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043
        env:
          CKV_SUMMARY: ${{ env.CKV_SUMMARY }}
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ env.CKV_SUMMARY }}
          edit-mode: replace

  checkov-scan-act:
    if: ${{ github.actor == 'nektos/act' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Detect Docker availability
        id: docker
        run: |
          set -euo pipefail
          if command -v docker >/dev/null 2>&1 && docker info >/dev/null 2>&1; then
            echo "available=true" >> "$GITHUB_OUTPUT"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run Checkov (Docker) and produce SARIF
        if: ${{ steps.docker.outputs.available == 'true' }}
        env:
          ACT: "true"
          # Under act, the script will no-op if CHECKOV_IMAGE_DIGEST isn't set in the environment.
        run: |
          set -euo pipefail
          bash tools/ci/checkov-run.sh
