name: resolve-ci-image

on:
    workflow_call:
        inputs:
            ci_image_tag:
                description: "Immutable tag for RuleHub CI images (e.g., 2025.10.03-<sha> or vX.Y.Z). Optional; falls back to CI_IMAGE_TAG var."
                required: false
                type: string
                default: ""
            kind:
                description: "Which CI image to resolve (base|policy|charts|frontend)"
                required: false
                type: string
                default: base
        outputs:
            image:
                description: "Resolved image reference"
                value: ${{ jobs.resolve.outputs.image }}
            tag:
                description: "Resolved tag"
                value: ${{ jobs.resolve.outputs.tag }}

permissions:
    contents: read
    packages: read

jobs:
    guard:
        name: Guard CI image tag
        runs-on: ubuntu-latest
        # Propagate repository/org variable vars.CI_IMAGE_TAG (or explicit input) into the environment
        # so the guard script can enforce pinned tags reliably on GitHub-hosted runners.
        env:
            CI_IMAGE_TAG: ${{ inputs.ci_image_tag != '' && inputs.ci_image_tag || vars.CI_IMAGE_TAG || '' }}
        steps:
            - name: Checkout
              uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955
            - name: Enforce non-latest CI image tag
              shell: bash
              run: bash .github/scripts/guard-ci-image-tag.sh "${{ inputs.ci_image_tag }}"

    resolve:
        name: Resolve image
        needs: guard
        runs-on: ubuntu-latest
        # Use the same propagation so the composite action can fall back to CI_IMAGE_TAG when input is empty.
        env:
            CI_IMAGE_TAG: ${{ inputs.ci_image_tag != '' && inputs.ci_image_tag || vars.CI_IMAGE_TAG || '' }}
        outputs:
            image: ${{ steps.r.outputs.image }}
            tag: ${{ steps.r.outputs.tag }}
        steps:
            - name: Checkout
              uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955
            - name: Resolve
              id: r
              uses: ./.github/actions/resolve-ci-image
              with:
                  ci_image_tag: ${{ inputs.ci_image_tag }}
                  kind: ${{ inputs.kind }}
