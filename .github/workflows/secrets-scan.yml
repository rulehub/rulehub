name: security-secrets

on:
  pull_request:
  push:
    branches: [main, master]
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: security-secrets-${{ github.ref }}
  cancel-in-progress: true

jobs:
  trufflehog-scan-gh:
    if: ${{ github.actor != 'nektos/act' }}
    name: TruffleHog secret scan (GitHub)
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955
        with:
          fetch-depth: 0

      - name: Detect local/act or skip-supplychain mode
        id: env_flags
        run: |
          set -euo pipefail
          skip=false
          if [ "${SKIP_SUPPLYCHAIN-}" = "1" ]; then
            skip=true
          fi
          echo "skip_supplychain=${skip}" >> "$GITHUB_OUTPUT"

      - name: Check PR base vs head
        id: check-diff
        run: bash .github/scripts/check-pr-diff.sh

      - name: Run TruffleHog via Docker (git range or filesystem)
        if: steps.env_flags.outputs.skip_supplychain != 'true' && steps.check-diff.outputs.skip != 'true'
        env:
          BASE: ${{ steps.check-diff.outputs.base }}
          HEAD: ${{ steps.check-diff.outputs.head }}
          TRUFFLEHOG_VERSION: 3.74.0
        run: bash .github/scripts/trufflehog-scan.sh

      - name: Skip TruffleHog (BASE==HEAD or SKIP_SUPPLYCHAIN)
        if: steps.check-diff.outputs.skip == 'true' || steps.env_flags.outputs.skip_supplychain == 'true'
        run: |
          echo "::warning::Skipping TruffleHog scan (BASE==HEAD or local act run)."

      - name: Post short PR summary (Step Summary)
        if: ${{ github.event_name == 'pull_request' && steps.env_flags.outputs.skip_supplychain != 'true' }}
        run: |
          echo "### Secret scanning" >> "$GITHUB_STEP_SUMMARY"
          echo "- Tool: TruffleHog" >> "$GITHUB_STEP_SUMMARY"
          echo "- See job logs for findings. Job fails if verified secrets are detected." >> "$GITHUB_STEP_SUMMARY"

  trufflehog-scan-act:
    if: ${{ github.actor == 'nektos/act' }}
    name: TruffleHog secret scan (act)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955
        with:
          fetch-depth: 0

      - name: Detect local/act or skip-supplychain mode
        id: env_flags
        run: |
          set -euo pipefail
          skip=false
          if [ "${SKIP_SUPPLYCHAIN-}" = "1" ]; then
            skip=true
          fi
          echo "skip_supplychain=${skip}" >> "$GITHUB_OUTPUT"

      - name: Check PR base vs head
        id: check-diff
        run: bash .github/scripts/check-pr-diff.sh || echo "skip=false" >> "$GITHUB_OUTPUT"

      - name: Run TruffleHog via Docker (git range or filesystem)
        if: steps.env_flags.outputs.skip_supplychain != 'true'
        env:
          BASE: ${{ steps.check-diff.outputs.base }}
          HEAD: ${{ steps.check-diff.outputs.head }}
          TRUFFLEHOG_VERSION: 3.74.0
        run: |
          if [ -n "${{ steps.check-diff.outputs.base }}" ] && [ -n "${{ steps.check-diff.outputs.head }}" ] && [ "${{ steps.check-diff.outputs.base }}" != "${{ steps.check-diff.outputs.head }}" ]; then
            bash .github/scripts/trufflehog-scan.sh
          else
            echo "[act] No PR base/head detected; running filesystem scan"
            export TRUFFLEHOG_ALLOW_FAILURE=1
            export TRUFFLEHOG_OUTPUT_JSON=trufflehog.json
            bash .github/scripts/trufflehog-scan.sh || true
          fi

      - name: Skip TruffleHog (BASE==HEAD or SKIP_SUPPLYCHAIN)
        if: steps.check-diff.outputs.skip == 'true' || steps.env_flags.outputs.skip_supplychain == 'true'
        run: |
          echo "::warning::Skipping TruffleHog scan (BASE==HEAD or local act run)."
