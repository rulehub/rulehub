# Contributing Guide

Thank you for helping improve RuleHub! This guide lists concise rules and conventions that speed up reviews and improve quality. The canonical brand is "RuleHub" (single word, capital R and H); avoid variants like "Rule Hub" except in technical lowercase identifiers (`rulehub` in package paths, image names, labels).

## Quick Start

1. Fork the repository and create a branch: feature/..., fix/... or docs/...
2. Install tooling:
   - Python & virtual env: `make setup-dev`
   - Runtime dependencies: `make deps`
   - Install pre-commit hooks: `make pre-commit-install`
3. Run local checks:
   - YAML lint: `make lint-yaml`
   - Python lint (tools): `make lint-py`
   - Python format (optional): `make format-py`
   - Kyverno tests: `make test-kyverno`
   - Gatekeeper/OPA tests: `make test-gatekeeper`
   - Full test suite: `make test`

- Full local verification (lint + tests + coverage + links): `make verify-all`
- Docs/style: markdownlint, Vale, cspell (run automatically via pre-commit)
- Rego style & deny[] rule usage scan: `make opa-quick-check` and `make deny-usage-scan`

## What You Can Improve

- Policies in `policies/` and `addons/` (Gatekeeper / Kyverno)
- Documentation in `docs/`
- Tooling in `tools/` (Python utilities)

## Style & Requirements

- YAML: follow existing templates, naming, and metadata schema. Run `make validate`.
  - Every policy metadata now requires a `geo` block with at least one region & country and a `scope` summary.
- Python: follow Ruff guidance; remove unused code.
- Commits: use clear messages. Conventional style prefixes like feat:, fix:, docs:, chore: are encouraged.
  - Breaking changes: add `!` after type (e.g. `feat!:`) or a `BREAKING CHANGE:` footer.
- Pull Requests: short problem statement, list of changes, link to issue (if any), brief test plan.

## Testing

- Kyverno: test cases in `tests/kyverno/`.
- Gatekeeper: test cases in `tests/gatekeeper/`.
- Ensure `make test` passes before opening a PR.
- Run `pre-commit run --all-files` before pushing to catch docs/style issues.

## Review Process

- All changes go via PR and at least one review.
- A maintainer may request changes or propose alternatives.
- After approval: prefer squash merge (unless multiple commits add clarity).

## Tooling Summary

| Area            | Enforcement                                          |
| --------------- | ---------------------------------------------------- |
| Rego formatting | `opa fmt` (pre-commit)                               |
| deny[] rule usage  | `make deny-usage-scan` (CI + hook)                 |
| Docs build      | GitHub Action `docs-build` (`mkdocs build --strict`) |
| Links           | Scheduled + PR link checker (`lychee`)               |
| Markdown style  | markdownlint (pre-commit)                            |
| Language style  | Vale (pre-commit)                                    |
| Spelling        | cspell (pre-commit)                                  |
| Python          | Ruff (lint/format), mypy                             |
| Compliance maps | Schema + duplicate check hooks                       |
| References idx  | Auto-generation hook (`refs-index`)                  |

If a hook fails, fix the underlying issue instead of skipping it.

### Updating documentation tool versions

Site build dependencies are pinned in `requirements-docs.txt` for reproducibility. To update:

1. Bump versions deliberately (e.g. `mkdocs==1.6.1`, `mkdocs-material==9.5.x`).
2. Run `pip install -r requirements-docs.txt` and `mkdocs build --strict` locally.
3. Review visual changes via `mkdocs serve`.
4. Commit the version bump and open a PR referencing any notable upstream changes.

### Python dependency locking

We maintain two lock files generated by pip-tools with hashes for supply chain integrity:

| Source file            | Lock file               | Command         |
| ---------------------- | ----------------------- | --------------- |
| `requirements.txt`     | `requirements.lock`     | `make lock`     |
| `requirements-dev.txt` | `requirements-dev.lock` | `make lock-dev` |

Rules:

1. Always run `make lock lock-dev` after editing either source requirements file.
2. Commit updated `*.lock` files in the same PR as the `*.txt` changes.
3. CI workflow `python-lock-verify` will fail if locks are stale.
4. A weekly scheduled workflow opens an automated PR refreshing the locks; review for major version jumps before merging.
5. Consumers installing locally / CI prefer the lock files when present to ensure reproducible, hash-verified installs.

Security note: Lock files include hashes (`--generate-hashes`) so pip will verify downloaded packages. If a supply chain alert requires pinning a specific version, update the source `.txt`, regenerate, and merge promptly.

## Releases

- See `RELEASE_CHECKLIST.md` and `README.md` for process and artifacts (OPA bundle, indexes, etc.).

## Reporting Security Issues

- Do not disclose vulnerabilities in Issues. Use the private channel defined in `SECURITY.md`.

Thank you for your contribution.
